<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Debug Panchang — OmKarmyog</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&family=Baloo+2:wght@700&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans Devanagari',sans-serif;background:#f6f6f6;padding:18px}
.container{max-width:920px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.06)}
label{display:block;margin-top:12px;font-weight:600}
input,button,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
button{cursor:pointer}
#preview{margin-top:12px;border:1px solid #eee;border-radius:8px;max-width:100%}
#log{white-space:pre-wrap;background:#0b2b3a;color:#fff;padding:10px;border-radius:6px;margin-top:12px;font-size:13px}
.info{color:#0b2b3a;margin-top:8px}
.bad{color:#b91c1c}
.good{color:#166534}
</style>
</head>
<body>
<div class="container">
  <h2 style="font-family:'Baloo 2'">Panchang Debug — OmKarmyog</h2>

  <div class="info">नंतरचे सर्व संदेश येथे दिसतील — कृपया Generate Card दाबल्यानंतर खालील लॉग बघा.</div>

  <label>नाव</label><input id="name" placeholder="उदा. संकेत रामदासी"/>
  <label>संपर्क</label><input id="mobile" placeholder="उदा. 98XXXXXXXX"/>
  <button id="generate">Generate Card (Debug)</button>
  <button id="download" disabled>Download PNG</button>

  <canvas id="canvas" width="1080" height="1316" style="display:none"></canvas>
  <img id="preview" alt="preview (1080x1316)"/>

  <div id="log">लॉग तयार होईल...</div>
</div>

<script>
const logEl = document.getElementById('log');
function log(...args){ logEl.textContent += '\n' + args.join(' '); console.log(...args); }
function clearLog(){ logEl.textContent = ''; }

function todayISO(){
  const d=new Date();
  const y=d.getFullYear();
  const m=('0'+(d.getMonth()+1)).slice(-2);
  const dd=('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${dd}`;
}

async function loadPanchangJSON(){
  const jsonUrl = './panchang.json'; // relative path — must be repo root
  log('1) Fetching JSON from:', jsonUrl);
  try{
    const res = await fetch(jsonUrl, {cache:'no-store'});
    log(' → HTTP status:', res.status, res.statusText);
    if(!res.ok) {
      throw new Error('Fetch failed: HTTP ' + res.status);
    }
    const text = await res.text();
    // quick parse check
    try{
      const obj = JSON.parse(text);
      log(' → JSON parsed OK. Keys in file:', Object.keys(obj).slice(0,10).join(', ')+ (Object.keys(obj).length>10 ? ' ...' : ''));
      return obj;
    }catch(pe){
      log(' *** JSON parse error: ', pe.message);
      // also show sample start of file for debugging
      log(' --- first 400 chars of file ---\n' + text.slice(0,400));
      throw new Error('JSON parse error: '+pe.message);
    }
  }catch(e){
    log('*** Load error:', e.message);
    throw e;
  }
}

function showAlertOnPage(msg, severity='info'){
  const el=document.createElement('div');
  el.textContent = msg;
  el.style.marginTop='8px';
  if(severity==='error'){ el.style.color='#b91c1c'; }
  else if(severity==='ok'){ el.style.color='#166534'; }
  document.querySelector('.container').appendChild(el);
}

function drawSimpleCard(p, name, mobile, canvas){
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fffaf3'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#012b46'; ctx.fillRect(0,0,canvas.width,120);
  ctx.fillStyle='#fff'; ctx.font='bold 56px Baloo 2'; ctx.fillText('आजचा पंचांग',48,78);
  ctx.font='28px Noto Sans Devanagari'; ctx.fillStyle='#0b2b3a';
  let x=48, y=160;
  ctx.fillText('तिथी: ' + (p.tithi || '—'), x, y); y+=48;
  ctx.fillText('वार: ' + (new Date().toLocaleDateString('mr-IN',{weekday:'long'})), x, y); y+=48;
  ctx.fillText('नक्षत्र: ' + (p.nakshatra || '—'), x, y); y+=48;
  ctx.fillText('योग: ' + (p.yog || '—'), x, y); y+=48;
  ctx.fillText('करण: ' + (p.karan || '—'), x, y); y+=48;
  // right column
  let rx = canvas.width/2 + 30, ry = 160;
  ctx.fillText('सूर्योदय: ' + (p.sunrise || '—'), rx, ry); ry+=40;
  ctx.fillText('सूर्यास्त: ' + (p.sunset || '—'), rx, ry); ry+=40;
  ctx.fillText('चंद्रराशी: ' + (p.moon_rashi || p.chandra_rashi || '—'), rx, ry); ry+=40;
  ctx.fillText('सूर्यराशी: ' + (p.sun_rashi || p.surya_rashi || '—'), rx, ry); ry+=40;
  // bottom
  ctx.fillStyle='#083b52'; ctx.fillRect(0, canvas.height-140, canvas.width, 140);
  ctx.fillStyle='#fff'; ctx.font='28px Noto Sans Devanagari'; ctx.fillText(name, 48, canvas.height-84);
  ctx.font='20px Noto Sans Devanagari'; ctx.fillText('संपर्क: ' + mobile, 48, canvas.height-44);
}

document.getElementById('generate').addEventListener('click', async ()=>{
  clearLog();
  log('=== Generate clicked ===');
  const name = document.getElementById('name').value || '';
  const mobile = document.getElementById('mobile').value || '';

  const date = todayISO();
  log('Today (ISO):', date);

  let json = null;
  try{
    json = await loadPanchangJSON();
  }catch(e){
    log('Stopping: cannot load JSON. See above.');
    showAlertOnPage('Error: panchang.json fetch/parse fail — बघा console आणि उपरी लॉग.', 'error');
    return;
  }

  if(!json[date]){
    log('JSON loaded but entry for today NOT found.');
    log('Available keys (first 8):', Object.keys(json).slice(0,8).join(', '));
    showAlertOnPage('आजचा पंचांग तुमच्या panchang.json मध्ये नाही — कृपया JSON मध्ये key "'+date+'" जोडा.', 'error');
    return;
  }

  const p = json[date];
  log('Panchang for today found. Rendering preview...');
  showAlertOnPage('Success: Panchang फाइल मिळाली आणि आजची entry आढळली.', 'ok');

  // draw
  const canvas = document.getElementById('canvas');
  drawSimpleCard(p, name, mobile, canvas);
  document.getElementById('preview').src = canvas.toDataURL('image/png');

  document.getElementById('download').disabled = false;
});

document.getElementById('download').addEventListener('click', ()=>{
  const a=document.createElement('a');
  a.href = document.getElementById('canvas').toDataURL('image/png');
  a.download = 'panchang_1080x1316.png';
  a.click();
});
</script>
</body>
</html>
