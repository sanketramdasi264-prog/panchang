<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>आजचे पंचांग — OmKarmyog (1080×1920)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --W:1080; --H:1920;
  --bg:#fffaf3;
  --saffron:#e56a2e;
  --gold:#d9a64b;
  --green1:#0d7c31;
  --green2:#08743f;
  --dark:#0b2b3a;
  --muted:#7a7a7a;
}
*{box-sizing:border-box}
body{margin:0;background:#f4f4f6;font-family:'Noto Sans Devanagari',sans-serif;color:var(--dark);padding:18px}
.container{max-width:980px;margin:12px auto}
.card-ui{background:#fff;border-radius:12px;padding:16px;box-shadow:0 12px 28px rgba(0,0,0,.08)}
label{display:block;margin-top:12px;font-weight:700}
input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e8e8e8;margin-top:6px;font-size:15px}
.controls{display:flex;gap:10px;margin-top:12px}
.btn{border:0;padding:12px;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}
.generate{background:#08324a}
.download{background:var(--saffron)}
.hint{font-size:13px;color:var(--muted);margin-top:8px}
canvas{display:none}
#preview{display:block;margin-top:12px;width:100%;border-radius:6px;border:1px solid #eee}
.small{font-size:12px;color:#666;margin-top:8px}
.note{font-size:12px;color:#9a9a9a;margin-top:8px}
@media(max-width:720px){ .controls{flex-direction:column} }
</style>
</head>
<body>
  <div class="container">
    <div class="card-ui">
      <h2 style="margin:0;font-family:'Baloo 2';font-size:20px">आजचे पंचांग — OmKarmyog</h2>
      <div class="hint">Card size: <strong>1080×1920</strong>. Generate → Download. Admin: keep <code>panchang.json</code> updated (YYYY-MM-DD).</div>

      <label>आपले नाव</label>
      <input id="username" placeholder="आपले नाव (उदा. श्री संकेत रामदासी गुरुजी)">

      <label>कार्यालय माहिती (ऐच्छिक)</label>
      <input id="office" placeholder="उदा. दत्तकृपा ज्योतिष कार्यालय, जालना">

      <label>संपर्क</label>
      <input id="mobile" placeholder="उदा. 98XXXXXXXX">

      <label>फोटो (ऐच्छिक) — square preferred</label>
      <input id="photo" type="file" accept="image/*">

      <div class="controls">
        <button id="generateBtn" class="btn generate">Generate Card</button>
        <button id="downloadBtn" class="btn download">Download PNG</button>
      </div>

      <canvas id="canvas" width="1080" height="1920"></canvas>
      <img id="preview" alt="Preview (1080×1920)" />
      <div class="note">If preview blank: check console for errors or confirm that <code>panchang.json</code> contains today's key (YYYY-MM-DD).</div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
/*
 Place images in repo root or change these URLs:
 - GANPATI_RAW: use your uploaded Ganpati PNG in repo (raw.githubusercontent).
 - LOGO_LOCAL: local logo filename in repo (1000894411.png).
 - PUNCH_JSON: panchang.json at repo root.
*/
const GANPATI_RAW = 'https://raw.githubusercontent.com/sanketramdasi264-prog/panchang/main/pngtree-artistic-vinayaka-chavithi-celebrations-for-ganesh-chaturthi-bal-free-transparent-png-image_14089909.png';
const LOGO_LOCAL = './1000894411.png';
const PUNCH_JSON = './panchang.json';
const W = 1080, H = 1920;

const el = id => document.getElementById(id);
let userPhotoData = null;
el('photo').addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f){ userPhotoData=null; return; }
  const r = new FileReader();
  r.onload = ()=> userPhotoData = r.result;
  r.readAsDataURL(f);
});

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = ('0'+(d.getMonth()+1)).slice(-2);
  const dd = ('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${dd}`;
}

function wrapText(ctx, text, x, y, maxW, lineH){
  const words = String(text).split(' ');
  let line = '';
  for(let n=0;n<words.length;n++){
    const test = line + words[n] + ' ';
    if(ctx.measureText(test).width > maxW && n>0){
      ctx.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineH;
    } else {
      line = test;
    }
  }
  ctx.fillText(line, x, y);
}

async function loadPanchang(){
  const res = await fetch(PUNCH_JSON, {cache:'no-store'});
  if(!res.ok) throw new Error('panchang.json fetch failed: ' + res.status);
  return await res.json();
}

/* ---------- Canvas helpers ---------- */
function roundRectPath(ctx,x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
}
function roundRectFill(ctx,x,y,w,h,r,color){
  ctx.save(); ctx.fillStyle=color; roundRectPath(ctx,x,y,w,h,r); ctx.fill(); ctx.restore();
}
function roundRectStroke(ctx,x,y,w,h,r,strokeStyle,lineWidth){
  ctx.save(); ctx.strokeStyle=strokeStyle; ctx.lineWidth=lineWidth||1; roundRectPath(ctx,x,y,w,h,r); ctx.stroke(); ctx.restore();
}
function circleIcon(ctx,x,y,label){
  ctx.save(); ctx.fillStyle='#f9c846'; ctx.beginPath(); ctx.arc(x,y,28,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='18px Noto Sans Devanagari'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label,x,y); ctx.restore();
}

/* ---------- Main draw ---------- */
async function drawCard(){
  const canvas = el('canvas'), ctx = canvas.getContext('2d');

  // load panchang data
  let p;
  try{
    const data = await loadPanchang();
    p = data[todayISO()];
    if(!p){
      // show friendly placeholder image (text) on canvas
      ctx.fillStyle = '#fffaf3'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle = '#c33'; ctx.font = '700 36px Baloo 2'; ctx.textAlign='center';
      ctx.fillText('आजचा पंचांग उपलब्ध नाही. कृपया पुन्हा भेट द्या.', W/2, H/2);
      el('preview').src = canvas.toDataURL('image/png');
      alert('आजचा पंचांग उपलब्ध नाही. कृपया panchang.json मध्ये आजची तारीख जोडा (YYYY-MM-DD).');
      return;
    }
  }catch(err){
    alert('panchang.json fetch error: ' + err.message);
    throw err;
  }

  // background
  ctx.fillStyle = '#fffaf3';
  ctx.fillRect(0,0,W,H);

  /* ---------- Ganpati top center ---------- */
  try{
    const gp = new Image(); gp.crossOrigin='anonymous'; gp.src = GANPATI_RAW;
    await new Promise((res,rej)=>{ gp.onload=res; gp.onerror=rej; });
    const tgtH = 320; const sc = tgtH / gp.height; const gw = gp.width * sc, gh = tgtH;
    const gx = W/2 - gw/2, gy = 36;
    ctx.drawImage(gp, gx, gy, gw, gh);
  }catch(e){
    console.warn('Ganpati not loaded', e);
  }

  /* ---------- Header left: "आजचे पंचांग" + date + day ---------- */
  ctx.fillStyle = '#111';
  ctx.textAlign = 'left';
  ctx.font = '700 42px Baloo 2'; // main title ~38-42
  ctx.fillText('आजचे पंचांग', 56, 460 - 70);

  ctx.font = '600 36px Noto Sans Devanagari';
  const d = new Date();
  const dateStr = d.toLocaleDateString('mr-IN',{day:'numeric', month:'long', year:'numeric'});
  const dayStr = d.toLocaleDateString('mr-IN',{weekday:'long'});
  ctx.fillText(dateStr, 56, 460 - 20);
  ctx.fillText(dayStr, 56, 460 + 20);

  /* ---------- Shalivahan lines centered under Ganpati (both same font size) ---------- */
  const meta1 = p.shalivahan || 'शालिवाहन शके १९४७';
  const meta2 = p.meta_long || 'विश्वावसु नाम संवत्सरे, दक्षिणायन, शरदऋतू, कार्तिक मास, कृष्ण पक्ष';

  ctx.textAlign = 'center';
  ctx.fillStyle = '#08324a';
  ctx.font = '700 36px Baloo 2'; // both same size as requested
  const metaY = 36 + 320 + 14;
  ctx.fillText(meta1, W/2, metaY);
  ctx.font = '700 36px Baloo 2';
  wrapText(ctx, meta2, W/2 - 420, metaY + 40, 840, 36);

  // thin orange divider
  ctx.strokeStyle = '#f24c27'; ctx.lineWidth = 4;
  ctx.beginPath(); ctx.moveTo(56, metaY + 72); ctx.lineTo(W - 56, metaY + 72); ctx.stroke();

  /* ---------- Big Panchang Table ---------- */
  const boxX = 56, boxY = metaY + 104, boxW = W - 112, boxH = 640;
  roundRectStroke(ctx, boxX, boxY, boxW, boxH, 18, '#e56a2e', 6);

  // soft watermark ellipse
  ctx.save(); ctx.globalAlpha = 0.04; ctx.fillStyle = '#dba84a'; ctx.beginPath(); ctx.ellipse(W/2, boxY + boxH/2 - 10, 420, 180, 0, 0, Math.PI*2); ctx.fill(); ctx.restore();

  // rows
  ctx.fillStyle = '#0b2b3a';
  ctx.font = '28px Noto Sans Devanagari';
  const startY = boxY + 72; const gap = 84; const textX = boxX + 120;
  let y = startY;

  // Row 1: तिथी
  circleIcon(ctx, boxX + 56, y - 8, 'ति');
  ctx.textAlign = 'left';
  ctx.fillText(`तिथी: ${p.tithi || ''}${p.tithi_end ? ' • समाप्ती: ' + p.tithi_end : ''}`, textX, y);
  ctx.textAlign = 'right';
  ctx.fillText(`${p.tithi_right || ''}`, boxX + boxW - 22, y); // optional right text override
  y += gap;

  // Row 2: वार
  circleIcon(ctx, boxX + 56, y - 8, 'वा');
  ctx.textAlign = 'left';
  ctx.fillText(`वार: ${new Date().toLocaleDateString('mr-IN',{weekday:'long'})}`, textX, y);
  ctx.textAlign = 'right';
  ctx.fillText(`${p.sanskrit_name || ''}`, boxX + boxW - 22, y);
  y += gap;

  // Row 3: नक्षत्र
  circleIcon(ctx, boxX + 56, y - 8, 'न');
  ctx.textAlign = 'left';
  ctx.fillText(`नक्षत्र: ${p.nakshatra || ''}${p.nak_end ? ' • समाप्ती: ' + p.nak_end : ''}`, textX, y);
  ctx.textAlign = 'right';
  ctx.fillText(`${p.moon_rashi || ''}`, boxX + boxW - 22, y);
  y += gap;

  // Row 4: योग
  circleIcon(ctx, boxX + 56, y - 8, 'यो');
  ctx.textAlign = 'left';
  ctx.fillText(`योग: ${p.yog || ''}`, textX, y);
  ctx.textAlign = 'right';
  ctx.fillText(`${p.sun_rashi || ''}`, boxX + boxW - 22, y);
  y += gap;

  // Row 5: करण
  circleIcon(ctx, boxX + 56, y - 8, 'क');
  ctx.textAlign = 'left';
  ctx.fillText(`करण: ${p.karan || ''}${p.karan_end ? ' • समाप्ती: ' + p.karan_end : ''}`, textX, y);
  ctx.textAlign = 'right';
  ctx.fillText(`${p.guru_rashi || ''}`, boxX + boxW - 22, y);
  y += gap;

  // Rahu time under rows (right aligned)
  ctx.font = '24px Noto Sans Devanagari'; ctx.textAlign = 'right';
  ctx.fillText(`राहू काल: ${p.rahu || ''}`, boxX + boxW - 22, y);

  /* small rashi bar */
  const stripY = boxY + boxH - 92;
  roundRectFill(ctx, boxX + 12, stripY, boxW - 24, 56, 10, '#08324a');
  ctx.fillStyle = '#fff'; ctx.font = '18px Noto Sans Devanagari'; ctx.textAlign = 'center';
  ctx.fillText(`चंद्र राशि - ${p.moon_rashi || ''}     सूर्य राशि - ${p.sun_rashi || ''}     गुरु राशि - ${p.guru_rashi || ''}`, W/2, stripY + 34);

  /* dinvishesh box */
  if(p.din_vishesh){
    const dvY = boxY + boxH + 18;
    roundRectFill(ctx, boxX, dvY, boxW, 84, 12, '#fff8e6');
    roundRectStroke(ctx, boxX, dvY, boxW, 84, 12, '#e2a92f', 2);
    ctx.fillStyle = '#0b2b3a'; ctx.font = '22px Noto Sans Devanagari'; ctx.textAlign='left';
    wrapText(ctx, `दिनविशेष: ${p.din_vishesh}`, boxX + 20, dvY + 48, boxW - 40, 28);
  }

  /* ---------- Footer (Green + Gold) ---------- */
  const footerH = 360, footerY = H - footerH - 20;
  const grad = ctx.createLinearGradient(0, footerY, 0, footerY + footerH);
  grad.addColorStop(0, '#0d7c31'); grad.addColorStop(1, '#08743f');
  ctx.fillStyle = grad; ctx.fillRect(0, footerY, W, footerH);

  // gold top stripe
  ctx.fillStyle = '#d9a64b'; ctx.fillRect(24, footerY + 10, W - 48, 12);

  // user info
  const usrName = el('username').value.trim() || 'आपले नाव';
  const usrOffice = el('office').value.trim() || '';
  const usrMobile = el('mobile').value.trim() || '';

  ctx.textAlign = 'left';
  ctx.fillStyle = '#ffd84a';
  ctx.font = '800 56px Baloo 2';
  ctx.fillText(usrName, 56, footerY + 120);

  ctx.fillStyle = '#fff';
  const officeSize = Math.round(56 * 0.80);
  ctx.font = `600 ${officeSize}px Noto Sans Devanagari`;
  if(usrOffice) ctx.fillText(usrOffice, 56, footerY + 170);
  if(usrMobile) ctx.fillText(`Contact: ${usrMobile}`, 56, footerY + 210);

  // big photo square right
  const photoSize = 360;
  const px = W - 56 - photoSize;
  const py = footerY + 12;
  // gold outer frame + white inner
  roundRectFill(ctx, px - 16, py - 16, photoSize + 32, photoSize + 32, 20, '#d9a64b');
  roundRectFill(ctx, px - 8, py - 8, photoSize + 16, photoSize + 16, 16, '#fff');

  if(userPhotoData){
    try{
      const img = new Image(); img.crossOrigin='anonymous'; img.src = userPhotoData;
      await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
      // crop center square
      let sx=0, sy=0, sw=img.width, sh=img.height;
      const r = img.width / img.height;
      if(r > 1){ sx = Math.floor((img.width - img.height)/2); sw = img.height; sh = img.height; }
      else if(r < 1){ sy = Math.floor((img.height - img.width)/2); sh = img.width; sw = img.width; }
      roundRectPath(ctx, px, py, photoSize, photoSize, 16); ctx.save(); ctx.clip();
      ctx.drawImage(img, sx, sy, sw, sh, px, py, photoSize, photoSize);
      ctx.restore();
    }catch(e){
      roundRectFill(ctx, px, py, photoSize, photoSize, 16, '#f2f2f2');
      ctx.fillStyle = '#999'; ctx.font = '18px Noto Sans Devanagari'; ctx.textAlign='center';
      ctx.fillText('आपला फोटो', px + photoSize/2, py + photoSize/2 + 6);
    }
  } else {
    roundRectFill(ctx, px, py, photoSize, photoSize, 16, '#f2f2f2');
    ctx.fillStyle = '#999'; ctx.font = '18px Noto Sans Devanagari'; ctx.textAlign='center';
    ctx.fillText('आपला फोटो', px + photoSize/2, py + photoSize/2 + 6);
  }

  // subtle repo logo watermark bottom-right
  try{
    const logo = new Image(); logo.crossOrigin='anonymous'; logo.src = LOGO_LOCAL;
    await new Promise((res,rej)=>{ logo.onload=res; logo.onerror=rej; });
    ctx.save(); ctx.globalAlpha = 0.12;
    const lw = 120, lh = (logo.height/logo.width)*lw;
    ctx.drawImage(logo, W - lw - 16, H - lh - 16, lw, lh);
    ctx.restore();
  }catch(e){ /* ignore */ }

  // set preview image
  el('preview').src = canvas.toDataURL('image/png');
}

/* ---------- Events ---------- */
el('generateBtn').addEventListener('click', async ()=>{
  el('generateBtn').disabled = true;
  try{ await drawCard(); }catch(e){ console.error(e); }
  el('generateBtn').disabled = false;
});
el('downloadBtn').addEventListener('click', ()=>{
  const a = document.createElement('a'); a.href = el('canvas').toDataURL('image/png'); a.download = `panchang_1080x1920.png`; a.click();
});
window.addEventListener('load', ()=> setTimeout(()=> el('generateBtn').click(), 500));
</script>
</body>
</html>
